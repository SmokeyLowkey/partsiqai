# ============================================
# PartsIQ Workers - Dockerfile
# Runs 10 BullMQ workers as a background service
# Deploy to Render.com as a Background Worker
# Uses node:20-slim (Debian) for OpenSSL compatibility with Prisma
# ============================================

# Stage 1: Install dependencies
FROM node:20-slim AS deps
RUN corepack enable pnpm
WORKDIR /app
COPY package.json pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile

# Stage 2: Generate Prisma client (openssl needed for correct engine detection)
FROM node:20-slim AS builder
RUN apt-get update -y && apt-get install -y openssl && rm -rf /var/lib/apt/lists/*
RUN corepack enable pnpm
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY prisma ./prisma
COPY package.json ./
RUN pnpm prisma generate

# Stage 3: Production runtime
FROM node:20-slim AS runner
RUN apt-get update -y && apt-get install -y openssl procps && rm -rf /var/lib/apt/lists/*
WORKDIR /app
ENV NODE_ENV=production

RUN groupadd --system --gid 1001 workers && \
    useradd --system --uid 1001 worker

# Copy node_modules with generated Prisma client
COPY --from=builder /app/node_modules ./node_modules

# Copy only what the workers need:
# - workers/     -> worker entry point + 10 worker files (including VoIP workers)
# - lib/         -> shared services (queue, prisma, logger, email, llm, storage, search, document)
# - prisma/      -> schema for Prisma client
# - tsconfig.json -> needed by tsx for path alias resolution (@/*)
# - package.json  -> needed by pnpm/tsx to run scripts
COPY workers ./workers
COPY lib ./lib
COPY prisma ./prisma
COPY tsconfig.json ./
COPY package.json ./

USER worker

# Health check: verify the process is running
HEALTHCHECK --interval=30s --timeout=10s --start-period=15s --retries=3 \
  CMD pgrep -f "workers/index" > /dev/null || exit 1

# Start workers via tsx (TypeScript executor) â€” called directly to avoid corepack at runtime
CMD ["node_modules/.bin/tsx", "workers/index.ts"]
